## Практическое задание по дисциплине "Сети и протоколы"
## Довыденков В.Н., 24.06.2025

### **Задание**

Разработать систему мониторинга использования DNS-резолверов конечными пользователями автономных систем российских интернет-провайдеров. Для этого необходимо:
- реализовать определение принадлежности IP-адресов автономным системам через базы whois и RADB,
- выявить используемые автономные системы по логам HTTP-сервера с сохранением данных в СУБД и отображением статистики,
- определить автономные системы DNS-провайдеров через анализ логов авторитетного DNS-сервера,
- освоить выпуск и автоматическое обновление wildcard-сертификатов Let’s Encrypt,
- реализовать сопоставление HTTP- и DNS-запросов,
- загрузку измерительного JavaScript-скрипта со стороннего сайта без ошибок CORS,
- отображение прогресса асинхронной загрузки контента на веб-странице,
- асинхронное взаимодействие с серверной БД по REST API,
- построение графика выделения номеров AS российским LIR по статистике RIPE NCC, а также определение unicast-адресов резолверов Национальной системы доменных имен по логам.

---

### **Реализация**

1.  **Определение принадлежности IP-адресов автономным системам через базы whois и RADB:**

      * Реализовано в файле `app/services/ip_lookup.py` функцией `resolve_ip_asn`.
      * Функция использует библиотеку `ipwhois` для запросов к базам Whois/RDAP.
      * Полученные данные (ASN и описание AS) сохраняются в таблице `as_info` в базе данных.
      * Вызов `resolve_ip_asn` происходит при получении нового HTTP-запроса (`@bp.before_app_request` в `app/routes/main.py`) и при добавлении новой записи DNS-лога (`add_dns_log`).

2.  **Выявление используемых автономных систем по логам HTTP-сервера с сохранением данных в СУБД и отображением статистики:**

      * **Сохранение данных:** Каждый входящий HTTP-запрос (IP, timestamp, путь) логируется в таблицу `http_logs` (`@bp.before_app_request` в `app/routes/main.py`). Одновременно выполняется поиск AS для IP-адреса и сохранение/обновление этой информации в `as_info`.
      * **Отображение логов:** Страница `/` (реализована функцией `index` в `app/routes/main.py`) отображает последние 50 HTTP-запросов с привязкой к AS, используя `http_logs.html` шаблон.
      * **Статистика AS:** Эндпоинт `/api/as_stats` (в `app/routes/api.py`) предоставляет JSON-данные о количестве запросов по каждой автономной системе. Эта статистика может быть использована для дальнейшей визуализации на клиентской стороне.

3.  **Определение автономных систем DNS-провайдеров через анализ логов авторитетного DNS-сервера:**

      * Система ожидает, что данные о DNS-запросах (IP резолвера, домен) будут поступать либо вручную через форму на `/dns_requests`, либо автоматически через JavaScript-скрипт (`measure.js`).
      * Данные сохраняются в таблицу `dns_logs`.
      * Страница `/dns_requests` отображает эти логи с соответствующей информацией об AS резолвера.
      * Страница `/dns_as_stats` (реализована функцией `dns_as_stats` в `app/routes/main.py` и шаблоном `dns_as_stats.html`) агрегирует и отображает количество уникальных IP-адресов резолверов для каждой AS, идентифицируя таким образом DNS-провайдеров.

4.  **Освоение выпуска и автоматического обновления wildcard-сертификатов Let’s Encrypt:**

      * Это требование реализуется отдельным Python-скриптом `ssl_automator.py`, который взаимодействует с Certbot.
      * Скрипт проверяет установку Certbot, использует плагин `dns-cloudflare` для DNS-01 аутентификации (требуются API-токены Cloudflare) и запрашивает wildcard-сертификаты (`*.domain` и `domain`).

5.  **Реализация сопоставления HTTP- и DNS-запросов:**

      * Страница `/dns_http_correlation` (функция `dns_http_correlation` в `app/routes/main.py` и шаблон `dns_http_correlation.html`) выполняет SQL-запрос (`JOIN`) между таблицами `http_logs` и `dns_logs` по IP-адресу.
      * Это позволяет просматривать, какие DNS-резолверы использовались тем же IP-адресом, который также делал HTTP-запросы к нашему сервису.

6.  **Загрузка измерительного JavaScript-скрипта со стороннего сайта без ошибок CORS:**

      * Файл `static/measure.js` выполняется на стороне клиента.
      * Он отправляет AJAX-запрос к `https://api.ipify.org` для определения публичного IP-адреса пользователя. Поскольку `api.ipify.org` имеет правильные CORS-заголовки, запрос выполняется без ошибок.
      * Затем этот IP и текущий домен отправляются на `/add_dns_log` endpoint Flask-приложения для сохранения в базе данных.

7.  **Отображение прогресса асинхронной загрузки контента на веб-странице:**

      * На страницах `http_logs.html` и `ripe_asn_chart.html` используются элементы `div` с `id="loader"` или `id="chart-loader"`.
      * Эти элементы отображаются до начала AJAX-запроса и скрываются после получения и обработки данных, показывая пользователю процесс загрузки.

8.  **Асинхронное взаимодействие с серверной БД по REST API:**

      * Приложение предоставляет несколько REST API эндпоинтов:
          * `/api/as_stats`: Возвращает статистику по AS из HTTP-логов.
          * `/api/ripe_as_stats`: Возвращает данные о выделении AS от RIPE NCC.
      * На клиентской стороне (в JavaScript в шаблонах `http_logs.html` и `ripe_asn_chart.html`) используются `fetch` запросы для асинхронного получения этих данных.

9.  **Построение графика выделения номеров AS российским LIR по статистике RIPE NCC, а также определение unicast-адресов резолверов Национальной системы доменных имен по логам:**

      * **График RIPE NCC:**
          * Эндпоинт `/api/ripe_as_stats` (в `app/routes/api.py`) скачивает актуальные данные `delegated-ripencc-latest` с FTP RIPE NCC, фильтрует их по российским LIR (`RU`) и типу `asn`, подсчитывает количество выделенных AS по годам.
          * Шаблон `ripe_asn_chart.html` использует библиотеку Chart.js для визуализации этих данных в виде столбчатой диаграммы.
      * **Unicast-адреса резолверов Национальной системы доменных имен:**
          * Текущая реализация собирает все IP-адреса DNS-резолверов.
          * **Для определения принадлежности к "Национальной системе доменных имен" потребуется дополнительная логика:** это может быть сверка IP-адресов резолверов с предопределенным списком IP-адресов или диапазонов, которые относятся к этой системе. В текущем коде есть только сбор `resolver_ip`, но нет конкретной классификации. Это требование требует дальнейшей разработки (например, создание справочника IP-адресов НСДИ и функции для их проверки).

### **Структура каталогов**

```
dns_monitor/
├── app/
│   ├── routes/
│   │   ├── main.py        # Основные маршруты веб-интерфейса
│   │   └── api.py         # Маршруты для REST API
│   ├── services/
│   │   └── ip_lookup.py   # Логика определения AS по IP
│   ├── static/
│   │   ├── measure.js     # JavaScript-скрипт для сбора DNS-информации
│   │   └── style.css      # Таблица стилей
│   ├── templates/
│   │   ├── base.html              # Базовый шаблон HTML
│   │   ├── dns_as_stats.html      # Шаблон для статистики DNS по AS
│   │   ├── dns_http_correlation.html # Шаблон для сопоставления HTTP/DNS
│   │   ├── dns_requests.html      # Шаблон для логов DNS-запросов
│   │   ├── http_logs.html         # Шаблон для логов HTTP-запросов
│   │   └── ripe_asn_chart.html    # Шаблон для графика RIPE NCC AS
│   ├── __init__.py        # Инициализация Flask-приложения
│   ├── config.py          # Конфигурация приложения (переменные окружения)
│   └── db.py              # Управление подключением к базе данных
├── docs/
│   └── database_structure.txt # Описание структуры базы данных
├── utils/
│   ├── init_db.py         # Скрипт для создания таблиц в PostgreSQL
│   └── ssl_automator.py   # Скрипт для автоматического выпуска/обновления SSL-сертификатов Let's Encrypt
├── .env                   # Файл с переменными окружения (SECRET_KEY, DB_DSN)
├── run.py                 # Точка входа для запуска Flask-приложения
├── requirements.txt       # Список зависимостей Python
└── README.md              # Документация проекта
```

---

### **Установка и настройка**

1.  **Установите зависимости:**

    ```bash
    pip install -r requirements.txt
    ```

2.  **Настройте PostgreSQL:**

      * Создайте БД (`my_monitor_db`) и пользователя (`myuser`:`mypassword`).
      * **Заполните `.env`** в корне проекта:
        ```dotenv
        SECRET_KEY="ваш_секретный_ключ"
        DB_DSN="postgresql://myuser:mypassword@localhost:5432/my_monitor_db"
        ```
      * **Инициализируйте таблицы БД:**
        ```bash
        python utils/init_db.py
        ```

3.  **Запустите приложение:**

    ```bash
    python run.py
    ```

    Доступно по `http://127.0.0.1:5000`.

4.  **Настройте SSL:**

      * Установите `certbot` и `python3-certbot-dns-cloudflare`.
      * Создайте `~/.secrets/cloudflare.ini` с `dns_cloudflare_api_token = ВАШ_ТОКЕН` (и `chmod 600`).
      * В `utils/ssl_automator.py` укажите ваш `CERTBOT_EMAIL`.
      * **Выпустите сертификат:**
        ```bash
        sudo python utils/ssl_automator.py your-domain.com
        ```
